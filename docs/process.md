# SSR êµ¬í˜„ ê³¼ì • ë° ë¬¸ì œ í•´ê²°

## âŒ ë¬¸ì œ ìƒí™©1 : í´ë¼ì´ì–¸íŠ¸ ì½”ë“œë¥¼ ì„œë²„ Node í™˜ê²½ì—ì„œ ì‹¤í–‰í•˜ë ¤ê³  í•´ì„œ ë°œìƒí•˜ëŠ” ì—ëŸ¬

### **ì—ëŸ¬ ë©”ì‹œì§€**

```
node:internal/modules/esm/resolve:263
    throw new ERR_UNSUPPORTED_DIR_IMPORT(path, basePath, String(resolved));
          ^

Error [ERR_UNSUPPORTED_DIR_IMPORT]: Directory import '/Users/angielee/Desktop/hanghae/front_6th_chapter4-1/packages/vanilla/src/components' is not supported resolving ES modules imported from /Users/angielee/Desktop/hanghae/front_6th_chapter4-1/packages/vanilla/src/pages/HomePage.js
```

### **ì—ëŸ¬ ì›ì¸**

í´ë¼ì´ì–¸íŠ¸ ì½”ë“œ ì„œë²„ ì‹¤í–‰: ë¸Œë¼ìš°ì €ìš© ì½”ë“œë¥¼ Node.js í™˜ê²½ì—ì„œ ì‹¤í–‰í•˜ë ¤ê³  ì‹œë„

```
const html = HomePage();
```

### âœ… í•´ê²° ë°©ë²•

Vite SSR ëª¨ë“ˆ ë¡œë“œ ë°©ì‹ ì‚¬ìš©

ê°œë°œ í™˜ê²½ì—ì„œëŠ” ë¸Œë¼ìš°ì € ì „ìš© ì½”ë“œë¥¼ Node.jsì—ì„œ ì§ì ‘ ì‹¤í–‰í•˜ë©´ ì•ˆ ë˜ë¯€ë¡œ, Viteì˜ `ssrLoadModule`ì„ ì‚¬ìš©í•´ ì„œë²„ ì „ìš© ì—”íŠ¸ë¦¬(`main-server.js`)ë¥¼ ë¶ˆëŸ¬ì˜¨ë‹¤.  
í”„ë¡œë•ì…˜ì—ì„œëŠ” ë¹Œë“œëœ SSR ë²ˆë“¤ì„ ë™ì ìœ¼ë¡œ importí•´ì„œ ì‚¬ìš©í•œë‹¤.

```js
const render = async (url) => {
  try {
    if (prod) {
      // í”„ë¡œë•ì…˜: ë¹Œë“œëœ SSR ëª¨ë“ˆ ì‚¬ìš©
      const { render } = await import("./dist/vanilla-ssr/main-server.js");
      return await render(url);
    } else {
      // ê°œë°œ: Vite SSR ëª¨ë“ˆ ë¡œë“œ
      const { render } = await vite.ssrLoadModule("/src/main-server.js");
      return await render(url);
    }
  } catch (error) {
    console.error("Render error:", error);
    return { html: "<div>Error</div>", head: "", initialData: {} };
  }
};
```

## âŒ ë¬¸ì œ ìƒí™©2 : fetch is not a function

### **ì—ëŸ¬ ë©”ì‹œì§€**

```
fetch is not a function
```

### **ì—ëŸ¬ ì›ì¸**

```js
const getTemplate = async () => {
  if (prod) {
    return fs.readFileSync(join(__dirname, "dist/vanilla/index.html"), "utf-8");
  } else {
    return fs.readFileSync("./dist/vanilla/index.html", "utf-8");
  }
};
```

- ê°œë°œ ëª¨ë“œì—ì„œ ë¹Œë“œëœ HTMLì„ ì‚¬ìš©
- ë¹Œë“œëœ HTMLì€ í”„ë¡œë•ì…˜ìš©ìœ¼ë¡œ ìµœì í™”ë˜ì–´ ìˆìŒ
- ê°œë°œ ëª¨ë“œì—ì„œëŠ” Viteì˜ ê°œë°œ ì„œë²„ ê¸°ëŠ¥ì´ í•„ìš”
- ë¹Œë“œëœ HTMLì—ëŠ” ê°œë°œìš© ìŠ¤í¬ë¦½íŠ¸ê°€ ì—†ì–´ì„œ fetch APIê°€ ì œëŒ€ë¡œ ë¡œë“œë˜ì§€ ì•ŠìŒ

### âœ… í•´ê²° ë°©ë²•

```js
const getTemplate = async () => {
  if (prod) {
    // ! í”„ë¡œë•ì…˜: ë¹Œë“œëœ HTML ì‚¬ìš©
    return fs.readFileSync(join(__dirname, "dist/vanilla/index.html"), "utf-8");
  } else {
    // ! ê°œë°œ: ê°œë°œìš© HTML ì‚¬ìš© + Vite ë³€í™˜
    // return fs.readFileSync("./dist/vanilla/index.html", "utf-8");

    let template = fs.readFileSync("./index.html", "utf-8");
    return await vite.transformIndexHtml("/*", template);
  }
};
```

ê°œë°œ ëª¨ë“œì—ì„œëŠ” Viteì˜ ê°œë°œ ì„œë²„ê°€ ì œê³µí•˜ëŠ” index.htmlì„ ì‚¬ìš©í•´ì•¼ í•œë‹¤.
ì´ë ‡ê²Œ í•˜ë©´ Viteê°€ í•„ìš”í•œ ê°œë°œìš© ìŠ¤í¬ë¦½íŠ¸ì™€ HMR(Hot Module Replacement) ë“±ì„ ìë™ìœ¼ë¡œ ì‚½ì…í•´ì¤€ë‹¤.
ë”°ë¼ì„œ, index.htmlì„ ì½ì€ ë’¤ vite.transformIndexHtmlë¡œ ë³€í™˜í•˜ì—¬ ë°˜í™˜í•œë‹¤.

## ğŸ“Š í˜„ì¬ SSR êµ¬í˜„ íë¦„ë„

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ í´ë¼ì´ì–¸íŠ¸ ìš”ì²­ â”‚
â”‚ (ë¸Œë¼ìš°ì €) â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
â”‚
â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Express ì„œë²„ â”‚
â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚ â”‚ 1. JSDOM í™˜ê²½ ì„¤ì • â”‚ â”‚
â”‚ â”‚ setupServerJsdom() â”‚ â”‚
â”‚ â”‚ - window, document, localStorage ë“± ì„¤ì • â”‚ â”‚
â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
â”‚
â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ ë¼ìš°íŠ¸ ì²˜ë¦¬ â”‚
â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚ â”‚ 2. URL íŒŒì‹± ë° ë¼ìš°íŠ¸ ë§¤ì¹­ â”‚ â”‚
â”‚ â”‚ app.use("\*all", async (req, res) => { â”‚ â”‚
â”‚ â”‚ const url = req.originalUrl.replace(base, ""); â”‚ â”‚
â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
â”‚
â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Vite SSR ëª¨ë“ˆ ë¡œë“œ â”‚
â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚ â”‚ 3. ê°œë°œí™˜ê²½: vite.ssrLoadModule("/src/main-server.js") â”‚ â”‚
â”‚ â”‚ í”„ë¡œë•ì…˜: import("./dist/vanilla-ssr/main-server.js")â”‚ â”‚
â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
â”‚
â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ main-server.js â”‚
â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚ â”‚ 4. ServerRouter ë¼ìš°íŠ¸ ë§¤ì¹­ â”‚ â”‚
â”‚ â”‚ - "/" â†’ HomePage â”‚ â”‚
â”‚ â”‚ - "/product/:id" â†’ ProductDetailPage â”‚ â”‚
â”‚ â”‚ - "/404" â†’ NotFoundPage â”‚ â”‚
â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
â”‚
â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ ë°ì´í„° í”„ë¦¬í˜ì¹­ â”‚
â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚ â”‚ 5. ë¼ìš°íŠ¸ë³„ ë°ì´í„° ë¡œë“œ â”‚ â”‚
â”‚ â”‚ - "/": getProducts({ limit: 20 }) â”‚ â”‚
â”‚ â”‚ - "/product/:id": getProduct(params.id) â”‚ â”‚
â”‚ â”‚ - Store ìƒíƒœ ì—…ë°ì´íŠ¸ â”‚ â”‚
â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
â”‚
â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ HTML ë Œë”ë§ â”‚
â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚ â”‚ 6. í˜ì´ì§€ ì»´í¬ë„ŒíŠ¸ ì‹¤í–‰ â”‚ â”‚
â”‚ â”‚ - HomePage() â†’ HTML ë¬¸ìì—´ â”‚ â”‚
â”‚ â”‚ - ProductDetailPage() â†’ HTML ë¬¸ìì—´ â”‚ â”‚
â”‚ â”‚ - NotFoundPage() â†’ HTML ë¬¸ìì—´ â”‚ â”‚
â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
â”‚
â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ í…œí”Œë¦¿ ì¹˜í™˜ â”‚
â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚ â”‚ 7. HTML í…œí”Œë¦¿ ì²˜ë¦¬ â”‚ â”‚
â”‚ â”‚ - index.html ì½ê¸° â”‚ â”‚
â”‚ â”‚ - <!--app-html--> â†’ ë Œë”ë§ëœ HTML â”‚ â”‚
â”‚ â”‚ - <!--app-head--> â†’ head íƒœê·¸ â”‚ â”‚
â”‚ â”‚ - window.**INITIAL_DATA** ìŠ¤í¬ë¦½íŠ¸ ì£¼ì… â”‚ â”‚
â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
â”‚
â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ ì‘ë‹µ ì „ì†¡ â”‚
â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚ â”‚ 8. ì™„ì„±ëœ HTML ì‘ë‹µ â”‚ â”‚
â”‚ â”‚ res.status(200).set({ "Content-Type": "text/html" })â”‚ â”‚
â”‚ â”‚ .end(finalHtml); â”‚ â”‚
â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
â”‚
â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ í´ë¼ì´ì–¸íŠ¸ í•˜ì´ë“œë ˆì´ì…˜ â”‚
â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚ â”‚ 9. ë¸Œë¼ìš°ì €ì—ì„œ JavaScript ì‹¤í–‰ â”‚ â”‚
â”‚ â”‚ - window.**INITIAL_DATA** ë³µì› â”‚ â”‚
â”‚ â”‚ - Store ìƒíƒœ ë™ê¸°í™” â”‚ â”‚
â”‚ â”‚ - ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ ì—°ê²° â”‚ â”‚
â”‚ â”‚ - ì¸í„°ë™í‹°ë¸Œ ê¸°ëŠ¥ í™œì„±í™” â”‚ â”‚
â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

```

## ğŸ”„ ì£¼ìš” ì»´í¬ë„ŒíŠ¸ë³„ ì—­í• 

### **server.js**

- Express ì„œë²„ ì„¤ì •
- JSDOM í™˜ê²½ ì´ˆê¸°í™”
- Vite ë¯¸ë“¤ì›¨ì–´ í†µí•©
- ë¼ìš°íŠ¸ í•¸ë“¤ë§ ë° í…œí”Œë¦¿ ì¹˜í™˜

### **main-server.js**

- ì„œë²„ì‚¬ì´ë“œ ë¼ìš°í„° êµ¬í˜„
- ë°ì´í„° í”„ë¦¬í˜ì¹­ ë¡œì§
- í˜ì´ì§€ ì»´í¬ë„ŒíŠ¸ ë Œë”ë§
- ì´ˆê¸° ìƒíƒœ ë°ì´í„° ìˆ˜ì§‘

### **setupJsDom.js**

- Node.js í™˜ê²½ì—ì„œ ë¸Œë¼ìš°ì € API ëª¨í‚¹
- window, document, localStorage ë“± ì„¤ì •
- fetch API ëŒ€ì²´ êµ¬í˜„

### **ServerRouter**

- ì •ê·œì‹ ê¸°ë°˜ ë¼ìš°íŠ¸ ë§¤ì¹­
- ë™ì  íŒŒë¼ë¯¸í„° ì¶”ì¶œ
- ë¼ìš°íŠ¸ í•¸ë“¤ëŸ¬ ì‹¤í–‰

## âš ï¸ í˜„ì¬ ë¬¸ì œì 

1. **Mock fetch ì‘ë‹µ êµ¬ì¡°**: API ì‘ë‹µê³¼ ì¼ì¹˜í•˜ì§€ ì•ŠëŠ” êµ¬ì¡°
2. **Store ìƒíƒœ ê´€ë¦¬**: ì„œë²„/í´ë¼ì´ì–¸íŠ¸ ê°„ ìƒíƒœ ë™ê¸°í™” ë¬¸ì œ
3. **ì—ëŸ¬ ì²˜ë¦¬**: ê° ë‹¨ê³„ë³„ ì—ëŸ¬ í•¸ë“¤ë§ ë¶€ì¡±
4. **ì„±ëŠ¥ ìµœì í™”**: ìºì‹± ë° ìµœì í™” ë¡œì§ ë¶€ì¬

```

## âŒ ë¬¸ì œ ìƒí™©3 : Prefetch error: TypeError: fetch is not a function

### **ì—ëŸ¬ ë©”ì‹œì§€**

```
Prefetch error: TypeError: fetch is not a function
```

### **ì—ëŸ¬ ì›ì¸**

- JSDOM í™˜ê²½ì—ì„œ fetchê°€ ì œëŒ€ë¡œ ì„¤ì •ë˜ì§€ ì•Šì•˜ê¸° ë•Œë¬¸

### âœ… í•´ê²° ë°©ë²•

- setupJsDom.jsì—ì„œ Node.jsì˜ ë‚´ì¥ fetchë¥¼ ìš°ì„ ì ìœ¼ë¡œ ì‚¬ìš©í•˜ë„ë¡ ìˆ˜ì •

```js
// Node.jsì˜ ë‚´ì¥ fetch ì‚¬ìš© (Node.js 18+)
if (typeof globalThis.fetch === "undefined") {
  // Node.js 18+ ì—ì„œëŠ” fetchê°€ ì „ì—­ìœ¼ë¡œ ì‚¬ìš© ê°€ëŠ¥
  if (typeof fetch !== "undefined") {
    globalThis.fetch = fetch;
  } else {
    console.warn("Node.js fetch not available, using jsdom fetch");
    globalThis.fetch = dom.window.fetch;
  }
}
```

## âŒ ë¬¸ì œ ìƒí™©4 : Prefetch error: TypeError: Failed to parse URL from /api/products?page=1&limit=20&sort=price_asc

### **ì—ëŸ¬ ë©”ì‹œì§€**

```
Prefetch error: TypeError: Failed to parse URL from /api/products?page=1&limit=20&sort=price_asc
```

### **ì—ëŸ¬ ì›ì¸**

> ì„œë²„ ì‚¬ì´ë“œì—ì„œ fetchë¥¼ ì‚¬ìš©í•  ë•Œ ìƒëŒ€ ê²½ë¡œ URLì„ íŒŒì‹±í•  ìˆ˜ ì—†ê¸° ë•Œë¬¸

> ìƒëŒ€ ê²½ë¡œì˜ ê¸°ì¤€ì ì´ ë‹¤ë¦„

- í´ë¼ì´ì–¸íŠ¸ í™˜ê²½: ë¸Œë¼ìš°ì €ì—ì„œ ì‹¤í–‰ë  ë•ŒëŠ” í˜„ì¬ í˜ì´ì§€ì˜ URLì´ ê¸°ì¤€ì 

ì˜ˆ: http://localhost:5173/products í˜ì´ì§€ì—ì„œ /api/productsëŠ” http://localhost:5173/api/productsë¡œ í•´ì„ë¨

- ì„œë²„ í™˜ê²½: Node.js ì„œë²„ì—ì„œ ì‹¤í–‰ë  ë•ŒëŠ” íŒŒì¼ ì‹œìŠ¤í…œì˜ í˜„ì¬ ì‘ì—… ë””ë ‰í† ë¦¬ê°€ ê¸°ì¤€ì 

ì˜ˆ: /api/productsëŠ” file:///api/productsë¡œ í•´ì„ë˜ê±°ë‚˜ ì—ëŸ¬ ë°œìƒ

### âœ… í•´ê²° ë°©ë²•

```js
// API ê¸°ë³¸ URL ì„¤ì •
const getApiBaseUrl = async () => {
  if (import.meta.env.SSR) {
    console.log("server logic");

    // ì„œë²„ í™˜ê²½ì—ì„œëŠ” ì ˆëŒ€ URL ì‚¬ìš©
    // ê°œë°œ í™˜ê²½: 5173, SSR ì„œë²„: 5174
    const port = process.env.PORT || 5174;

    return `http://localhost:${port}`;
  } else {
    console.log("client logic");

    // í´ë¼ì´ì–¸íŠ¸ í™˜ê²½ì—ì„œëŠ” ìƒëŒ€ URL ì‚¬ìš©
    return "";
  }
};
```

í™˜ê²½ì— ë”°ë¼ baseURL ë‹¤ë¥´ê²Œ ì„¤ì •
ssr í™˜ê²½ì—ì„œëŠ” ì ˆëŒ€ê²½ë¡œ ì‚¬ìš©

> ê·¼ë°ë„ ê³„ì† ì—ëŸ¬ ë°œìƒ

> Prefetch error: SyntaxError: Unexpected token '<', "<!doctype "... is not valid JSON

### **ì—ëŸ¬ ì›ì¸**

- SSR ì„œë²„ì— API ë¼ìš°íŠ¸ê°€ êµ¬í˜„ë˜ì§€ ì•Šì•˜ê¸° ë•Œë¬¸ì…ë‹ˆë‹¤. SSR ì„œë²„ê°€ API ì„œë²„ ì—­í• ë„ í•˜ë„ë¡ ìˆ˜ì •

### âœ… í•´ê²° ë°©ë²•

MSW(Mock Service Worker)ë¥¼ ì‹¤ì œë¡œ ë™ì‘í•˜ê²Œ ë§Œë“­ë‹ˆë‹¤
listen() ë©”ì„œë“œê°€ í˜¸ì¶œë˜ì–´ì•¼ MSWê°€ ìš”ì²­ì„ ê°€ë¡œì±„ê¸° ì‹œì‘í•©ë‹ˆë‹¤

```
mswServer.listen({
  onUnhandledRequest: "bypass",
});
```

MSWê°€ ëª¨í‚¹í•˜ì§€ ì•Šì€ API ìš”ì²­ì„ ë§Œë‚¬ì„ ë•Œ
í•´ë‹¹ ìš”ì²­ì„ MSWê°€ ê°€ë¡œì±„ì§€ ì•Šê³  ê·¸ëŒ€ë¡œ í†µê³¼ì‹œí‚µë‹ˆë‹¤
ì‹¤ì œ ë„¤íŠ¸ì›Œí¬ë¡œ ìš”ì²­ì´ ì „ë‹¬ë˜ì–´ ì‹¤ì œ API ì„œë²„ì— ë„ë‹¬í•©ë‹ˆë‹¤

```
// MSWë¡œ ëª¨í‚¹ëœ API
GET /api/mocked-endpoint â†’ MSWê°€ ê°€ë¡œì±„ì„œ ëª¨ì˜ ë°ì´í„° ë°˜í™˜

// MSWë¡œ ëª¨í‚¹ë˜ì§€ ì•Šì€ API
GET /api/products â†’ MSWê°€ ê°€ë¡œì±„ì§€ ì•Šê³  ì‹¤ì œ ì„œë²„ë¡œ ì „ë‹¬
```
