# Vite SSR 구현 Q&A

## Q1: 지금 vanilla에서 ssr을 구현해보려고 하는데, @packages/vanilla/server.js를 위와 같이 수정했거든, 왜 이렇게 수정해야하는지 https://ko.vite.dev/guide/ssr를 참조해서 나한테 설명해줘.

### A1: Vite SSR 가이드에 따라 미들웨어 모드와 템플릿 변환이 필요하기 때문입니다.

## 1. 미들웨어 모드 사용
```javascript
vite = await createServer({
  server: { middlewareMode: true },
  appType: "custom",
  base,
});
```
## Q2: Vite를 미들웨어 모드로 실행해서 HTML 서빙 로직을 직접 제어할 수 있게 합니다. 이게 무슨 소리야?

### A2: "미들웨어 모드"는 Vite의 개발 서버를 다른 Express 서버 안에 통합해서 사용하는 방식입니다.

**일반 모드 vs 미들웨어 모드:**
- **일반 모드**: Vite가 자체 서버를 실행하고 모든 요청을 직접 처리
- **미들웨어 모드**: Vite를 Express 앱의 미들웨어로 추가해서 기존 서버에 통합

## Q3: 이게 왜 ssr 모드를 위해서 필요한거야?

### A3: SSR에서는 **서버에서 HTML을 동적으로 생성**해야 하기 때문입니다.

**일반 모드 (SPA):**
```
브라우저 요청 → Vite가 빈 HTML + JS 번들 제공 → 브라우저에서 JS 실행해서 DOM 생성
```

**SSR 모드:**
```
브라우저 요청 → 서버에서 앱 실행해서 HTML 생성 → 완성된 HTML을 브라우저에 제공
```

일반 Vite 모드에서는 항상 같은 빈 HTML을 제공하지만, SSR에서는 각 요청마다 다른 내용의 HTML을 서버에서 미리 렌더링해서 보내야 합니다. 미들웨어 모드를 사용하면 Vite의 개발 기능(HMR, 트랜스폼)은 유지하면서도 HTML 응답을 직접 제어할 수 있습니다.

## Q4: 미들웨어 모드를 사용하면 어떻게 Vite의 개발 기능(HMR, 트랜스폼)은 유지하면서도 HTML응답을 제어할 수 있는거야?

### A4: **책임 분리**를 통해 이를 달성합니다:

**Vite가 담당하는 부분 (개발 기능):**
```javascript
app.use(vite.middlewares);
```
- **모듈 변환**: `.ts`, `.vue`, `.jsx` 등을 브라우저가 이해할 수 있는 JS로 변환
- **HMR**: 파일 변경 감지하고 브라우저에 업데이트 신호 전송
- **정적 파일 서빙**: CSS, 이미지 등의 에셋 처리

**Express가 담당하는 부분 (HTML 응답 제어):**
```javascript
app.use("*", async (req, res) => {
  // 여기서 HTML 응답을 직접 제어
  const rendered = await render(url);
  const html = template.replace('<!--app-html-->', rendered.html);
  res.send(html);
});
```

**실제 요청 흐름:**
1. **정적 파일 요청** (`/src/main.js`, `/style.css` 등) → Vite 미들웨어가 처리
2. **HTML 페이지 요청** (`/`, `/about` 등) → Express의 `"*"` 핸들러가 SSR 처리

**개발 기능이 유지되는 이유:**
```javascript
// 개발 모드에서
template = await vite.transformIndexHtml(url, template);
// ↑ Vite가 템플릿에 HMR 클라이언트 코드 주입

render = (await vite.ssrLoadModule("/src/main-server.js")).render;
// ↑ Vite가 서버 코드도 실시간 변환/리로드
```

즉, **모듈 변환과 HMR은 Vite**가, **최종 HTML 조립과 응답은 Express**가 담당하면서 둘 다 동작할 수 있습니다.

## 추가 설명

### 2. 개발/프로덕션 환경 분기
- **개발**: `vite.ssrLoadModule()`로 서버 엔트리를 동적 로드하고 HMR 지원
- **프로덕션**: 미리 빌드된 파일을 `import()`로 로드해서 성능 최적화

## 3. 템플릿 변환 과정
```javascript
template = await vite.transformIndexHtml(url, template);
const rendered = await render(url);
const html = template
  .replace('<!--app-head-->', rendered.head ?? "")
  .replace('<!--app-html-->', rendered.html ?? "");
```
- HTML 템플릿을 Vite가 변환 (HMR 클라이언트 주입, 플러그인 변환 적용)
- 앱을 서버에서 렌더링
- 렌더링된 내용을 템플릿에 주입

## 4. 에러 처리
```javascript
vite?.ssrFixStacktrace(e);
```
`vite.ssrFixStacktrace()`를 사용해서 에러를 실제 소스코드 위치로 매핑합니다.

이런 구조를 통해 개발과 프로덕션 환경에서 모두 동작하는 유연하고 성능 좋은 SSR 구현이 가능합니다.