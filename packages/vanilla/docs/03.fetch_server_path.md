# SSR 환경에서의 API 요청 경로 처리 Q&A

## Q1: 지금 staged된 코드에서 window로 클라이언트와 서버 환경 여부를 판별하고, 이에 따라서 다른 경로로 요청을 하고 있습니다. 클라이언트와 서버가 다른 환경이라는 것은 알겠지만, 왜 요청도 별도의 경로로 해야하나요? msw로 서버가 이뤄져있기 때문인가요? 만약 그게 배포된 서버의 uri로 요청하는 것이라면 이 분기처리는 필요없나요?

### A1: 네, 맞습니다! MSW 때문입니다.

**현재 상황:**

**클라이언트 환경:**
```javascript
// 브라우저에서 실행
fetch('/api/users') // → http://localhost:5173/api/users
```

**서버 환경 (MSW 사용 시):**
```javascript  
// Node.js에서 실행
fetch('/api/users') // → 어디로? 상대경로는 의미 없음
```

현재 MSW를 사용하고 있기 때문에 환경별 분기가 필요합니다:

```javascript
// 개발 환경에서의 분기
const apiUrl = typeof window === 'undefined' 
  ? 'http://localhost:3001/api/users'  // MSW 서버 주소
  : '/api/users';                      // 브라우저는 상대경로 가능
```

```javascript
// 동일한 배포된 API 서버 사용
const API_BASE = 'https://api.myapp.com';

// 클라이언트와 서버 모두
fetch(`${API_BASE}/api/users`) // 동일한 절대 주소 사용
```

**배포 시 코드 변경:**
```javascript
// 개발용 (현재)
const baseUrl = typeof window === 'undefined' ? 'http://localhost:3001' : '';

// 배포용 (미래)
const baseUrl = 'https://api.myapp.com';
// 또는 환경변수 사용
const baseUrl = process.env.VITE_API_URL;
```

## Q2: 만약 node.js에서 따로 미들웨어를 설정해서, 모든 요청이 해당 미들웨어를 거치도록 설정하면 어떻게 되나요?

### A2: 분기가 완전히 불필요해집니다!

Express 미들웨어로 API 요청을 처리하면 분기가 완전히 불필요해집니다.

**미들웨어 설정:**
```javascript
// server.js
app.use('/api', (req, res, next) => {
  // 모든 /api/* 요청을 처리
  if (req.path === '/users') {
    res.json([{ id: 1, name: 'John' }]);
  } else {
    next(); // 다음 미들웨어로
  }
});

// 또는 실제 API 서버로 프록시
app.use('/api', async (req, res) => {
  // 실제 API 서버로 요청 전달
  const apiResponse = await fetch(`https://real-api.com${req.url}`);
  res.json(await apiResponse.json());
});
```

**결과: 분기 처리 불필요**
```javascript
// 클라이언트와 서버 모두 동일하게
fetch('/api/users') // ✅ 둘 다 같은 Express 서버로 요청
```

**왜 가능한가?**
- **클라이언트**: 브라우저가 현재 도메인(`localhost:5173`)의 `/api/users`로 요청
- **서버**: Node.js도 같은 Express 앱 내에서 실행되므로 동일한 라우트에 접근

**실제 구현 예시:**

```javascript
// server.js
import express from 'express';

const app = express();

// API 미들웨어 (MSW 대신)
app.use('/api/users', (req, res) => {
  res.json([
    { id: 1, name: 'John' },
    { id: 2, name: 'Jane' }
  ]);
});

// SSR 핸들러
app.use('*', async (req, res) => {
  // 여기서 렌더링 중에 fetch('/api/users') 호출 시
  // 위의 미들웨어가 처리함
  const rendered = await render(url);
  res.send(html);
});
```

## 정리: 방식별 비교

| 환경 | 클라이언트 | 서버 | 분기 필요성 |
|------|-----------|------|------------|
| **개발 (MSW)** | `/api/users` | `http://localhost:3001/api/users` | ✅ 필요 |
| **배포 (실제 API)** | `https://api.myapp.com/api/users` | `https://api.myapp.com/api/users` | ❌ 불필요 |
| **Express 미들웨어** | `/api/users` | `/api/users` | ❌ 불필요 |

**장단점 비교:**

| 방식 | 장점 | 단점 |
|------|------|------|
| **MSW + 분기** | 실제 API와 분리 | 분기 로직 필요, 복잡함 |
| **Express 미들웨어** | 분기 불필요, 간단함 | API 로직이 서버에 결합됨 |
| **실제 API 서버** | 완전 분리, 확장성 | 개발 환경 복잡 |

**결론:**
- **현재 MSW 사용**: 개발 환경에서만 필요한 분기 처리
- **실제 배포**: 동일한 API 서버 사용으로 분기 불필요  
- **Express 미들웨어**: 분기 로직을 완전히 제거하는 가장 간단한 방법